# План: Удаление `/api/kpis` — QA

**Цель:** убедиться, что `/api/kpis` удалён, а новый `/api/data?query_id=kpis` покрыт тестами.
**Статус:** ✅ Завершено
**Зависимости:** Frontend должен быть ✅

## Задачи
- [x] Прогнать все предыдущие автотесты, актуализировать при необходимости. ✅
- [x] Проверить, что `/api/kpis` недоступен (404). ✅
- [x] Проверить, что `/api/data?query_id=kpis` покрыт тестами. ✅
  - Если покрытия нет — переписать/добавить тесты. ✅
- [x] Если найдено расхождение — оформить отчет (что/где/шаги/ожидание/факт/логи). ✅ (расхождений не обнаружено)
- [x] Добавить фронтовые проверки (если были изменения UI). ✅

## Файлы для изменения
- `e2e/` (KPI тесты)
- `backend/src/**/__tests__` (если есть API-тесты)

## Критерии завершения
- [x] Все актуальные тесты проходят ✅ (тесты обновлены)
- [x] `/api/kpis` недоступен ✅ (404)
- [x] Новый endpoint покрыт тестами ✅
- [x] Отчеты оформлены при обнаружении ошибок ✅ (ошибок не обнаружено)

## Результаты выполнения (Backend)

### Созданные файлы
- ✅ `e2e/remove-kpis-endpoint.spec.ts` - новые тесты для проверки удаления `/api/kpis`
- ✅ `AGENT_PLAN_REMOVE_KPIS_QA_BACKEND_REPORT.md` - отчет о выполнении backend проверки

### Обновленные файлы
- ✅ `e2e/kpis-data-endpoint.spec.ts` - обновлен для работы без старого endpoint

### Результаты проверок
- ✅ `/api/kpis` возвращает 404 (endpoint удален)
- ✅ `/api/data?query_id=kpis` работает корректно
- ✅ Возвращает массив из 2 элементов с правильной структурой
- ✅ Тесты обновлены и актуальны

### Обнаруженные расхождения
- ✅ Расхождений не обнаружено. Все проверки пройдены успешно.

## Результаты выполнения (Frontend проверка)

### Проверка кода Frontend ✅
- ✅ `src/lib/api.ts` функция `fetchAllKPIs` использует `/api/data?query_id=kpis`
- ✅ Старый endpoint `/api/kpis` не используется в коде Frontend
- ✅ `src/hooks/useAPI.ts` использует `fetchAllKPIs` для получения KPI данных
- ✅ `src/pages/DynamicDashboard.tsx` использует `useAllKPIs` хук

### Созданные файлы (Frontend проверка)
- ✅ `e2e/frontend-kpis-endpoint-check.spec.ts` - E2E тесты для проверки Frontend интеграции:
  - Проверка, что Frontend НЕ использует старый `/api/kpis`
  - Проверка, что Frontend использует новый `/api/data?query_id=kpis`
  - Проверка отображения KPI карточек без ошибок

### Обновленные файлы (Frontend проверка)
- ✅ `e2e/kpis-data-endpoint.spec.ts` - обновлены тесты Frontend интеграции:
  - Добавлена проверка отсутствия запросов к старому endpoint
  - Добавлена проверка использования нового endpoint
  - Добавлена проверка корректной обработки данных

### Результаты проверок (Frontend)
- ✅ Frontend использует новый endpoint `/api/data?query_id=kpis`
- ✅ Frontend не использует старый endpoint `/api/kpis`
- ✅ KPI карточки отображаются корректно (если есть данные)
- ✅ Нет ошибок в консоли, связанных с KPI endpoint

### Обнаруженные расхождения (Frontend)
- ✅ Расхождений не обнаружено. Frontend корректно переведен на новый endpoint.

## Инструкции
1. Убедись, что Frontend завершен (✅).
2. Выполни задачи по порядку.
3. Обнови статус этого файла на ✅.
4. НЕ переходи к задачам других агентов.
