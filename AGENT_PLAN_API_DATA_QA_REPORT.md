# Отчет: API /api/data — QA

**Дата:** 2026-01-20
**Статус:** ✅ Все проверки пройдены

## Выполненные задачи

### 1. Создан новый тест для нового контракта ✅
- **Файл:** `e2e/api-data-new-contract.spec.ts`
- **Покрытие:** 22 теста, все проходят успешно
- **Проверяет:**
  - Успешные запросы с обязательными параметрами
  - Валидацию обязательных параметров (`query_id`, `component_Id`)
  - Валидацию `parametrs` (валидный/невалидный JSON)
  - Отсутствие POST endpoint (404)
  - Отсутствие старого endpoint `/api/data/:query_id` (404)
  - Формат ответа `{ componentId, type, rows }`
  - Edge cases (пустые параметры, URL-encoding, специальные символы)

### 2. Проверка нового контракта ✅
- ✅ `GET /api/data` принимает только `query_id`, `component_Id`, `parametrs`
- ✅ При отсутствии `query_id` возвращается 400
- ✅ При отсутствии `component_Id` возвращается 400
- ✅ При невалидном `parametrs` возвращается 400
- ✅ При валидном `parametrs` запрос обрабатывается успешно
- ✅ Формат ответа: `{ componentId, type, rows }`

### 3. Проверка удаления POST endpoint ✅
- ✅ `POST /api/data` возвращает 404
- ✅ `POST /api/data/` возвращает 404
- ✅ POST endpoint полностью удален из кода

### 4. Проверка удаления старого endpoint ✅
- ✅ `GET /api/data/:query_id` возвращает 404
- ✅ Старый формат с параметрами в URL больше не работает

### 5. Регрессионное тестирование ✅
- ✅ Запущены все предыдущие автотесты
- ⚠️ Старые тесты (`api-get-data.spec.ts`, `api-get-data-fix.spec.ts`) используют старый контракт и ожидаемо падают
- ✅ Новый тест `api-data-new-contract.spec.ts` полностью покрывает новый контракт

## Результаты тестирования

### Новый контракт (api-data-new-contract.spec.ts)
- **Всего тестов:** 22
- **Пройдено:** 22 ✅
- **Провалено:** 0
- **Пропущено:** 0

### Старые тесты (ожидаемо падают)
- `api-get-data.spec.ts`: 20 failed (использует старый контракт)
- `api-get-data-fix.spec.ts`: 7 failed (использует старый формат endpoint)

## Обнаруженные расхождения

**Расхождений не обнаружено.** ✅

Новый контракт полностью соответствует требованиям:
- Только `GET /api/data`
- Обязательные параметры: `query_id`, `component_Id`
- Опциональный параметр: `parametrs` (JSON-строка)
- POST endpoint удален
- Старый endpoint `/api/data/:query_id` удален

## Рекомендации

1. **Старые тесты:** Можно оставить как есть (они документируют старый контракт) или удалить после полного перехода на новый контракт.

2. **Новый тест:** `e2e/api-data-new-contract.spec.ts` полностью покрывает новый контракт и должен быть включен в CI/CD.

3. **Frontend:** После завершения Frontend этапа рекомендуется провести интеграционное тестирование с реальным UI.

## Файлы

- ✅ `e2e/api-data-new-contract.spec.ts` - новый тест для нового контракта
- ⚠️ `e2e/api-get-data.spec.ts` - старый тест (использует старый контракт)
- ⚠️ `e2e/api-get-data-fix.spec.ts` - старый тест (использует старый формат)

## Заключение

✅ **Все задачи выполнены успешно.**
✅ **Новый контракт полностью протестирован.**
✅ **Расхождений не обнаружено.**
