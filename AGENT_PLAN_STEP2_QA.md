# План: Шаг 2 — QA

**Цель:** проверить SQL builder v1 на подстановку параметров.
**Статус:** ✅ Завершено

## Задачи
- [x] Проверить:
  - даты/строки оборачиваются в кавычки ✅
  - числа и bool без кавычек ✅
  - отсутствие параметра → ошибка ✅
  - корректная сборка SQL из config ✅
- [x] Обновить тест‑кейсы и тесты под новые ожидания ✅

## Файлы для изменения
- `backend/src/services/queryBuilder/__tests__/builder.test.ts`
- `backend/src/services/queryBuilder/__tests__/validator.test.ts`

## Критерии завершения
- [x] Все тесты проходят ✅
- [x] Поведение соответствует контракту ✅

## Результаты проверки

### Тесты для buildQuery (прямая подстановка значений)
1. **Строки и даты оборачиваются в кавычки** ✅
   - Тест: строки → `'value'`
   - Тест: даты → `'2025-01-15'`
   - Тест: экранирование одинарных кавычек → `'test''value'`

2. **Числа без кавычек** ✅
   - Тест: числа остаются как есть → `100`, `1000`
   - Проверка: нет `'100'` в SQL

3. **Булевы значения как TRUE/FALSE** ✅
   - Тест: `true` → `TRUE`
   - Тест: `false` → `FALSE`
   - Проверка: нет кавычек вокруг булевых

4. **Отсутствие параметра → ошибка** ✅
   - Тест: выбрасывается `"invalid params"` при отсутствии обязательного параметра

5. **Корректная сборка SQL из config** ✅
   - Тест: case_agg с подставленными значениями
   - Тест: WHERE IN с подставленными значениями
   - Тест: WHERE BETWEEN с подставленными значениями
   - Тест: is_null/is_not_null без значений

### Тесты для buildQueryFromId (загрузка из БД)
1. **Загрузка конфига header_dates из БД** ✅
   - Тест: успешная загрузка и построение SQL

2. **Загрузка конфига assets_table из БД** ✅
   - Тест: успешная загрузка с параметрами
   - Тест: подстановка значений в SQL
   - Тест: проверка структуры SQL (SELECT, FROM, WHERE, GROUP BY, ORDER BY)

3. **Обработка ошибок** ✅
   - Тест: несуществующий query_id → `"invalid config"`
   - Тест: отсутствие параметров → `"invalid params"`

### Обновленные тесты
- ✅ Все тесты обновлены под новую сигнатуру `buildQuery(config, params)`
- ✅ Добавлены тесты для `buildQueryFromId(queryId, params)`
- ✅ Тесты проверяют отсутствие параметризованных значений (`$1`, `$2`) в финальном SQL
- ✅ Тесты проверяют отсутствие named параметров (`:param`) в финальном SQL
