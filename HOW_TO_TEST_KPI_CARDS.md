# Как протестировать отображение KPI карточек на фронтенде

## Быстрая проверка (через скрипт)

```bash
bash test-kpi-cards-display.sh
```

Скрипт проверит:
- ✅ Доступность фронтенда
- ✅ Работу API endpoint для KPIs
- ✅ Количество элементов в ответе
- ✅ Сравнение старого и нового endpoint

## Проверка в браузере (DevTools)

### Шаг 1: Откройте DevTools
1. Откройте `http://localhost:8080` в браузере
2. Нажмите F12 или Cmd+Option+I
3. Перейдите на вкладку **Network**

### Шаг 2: Проверьте запросы к API
1. Обновите страницу (F5)
2. Найдите запросы к `/api/data?query_id=kpis`
3. Кликните на запрос
4. Проверьте:
   - **Status Code:** должен быть 200 (не 400 или 500)
   - **Response:** должен содержать массив с KPI данными

### Шаг 3: Проверьте ответ API
**Ожидаемый формат:**
```json
[
  {
    "id": "capital_card",
    "periodDate": "2025-12-31",
    "value": 11200000000,
    ...
  },
  {
    "id": "roa_card",
    ...
  }
]
```

**Если видите ошибку:**
- `SQL execution error` - проблема в Backend
- `invalid params` - проблема с параметрами запроса
- `404` - endpoint не найден

### Шаг 4: Проверьте элементы на странице
1. Перейдите на вкладку **Elements** (или **Inspector**)
2. Найдите элементы с атрибутами:
   - `data-component-type="card"`
   - `data-component-id="capital_card"` (или `roa_card`, `roe_card`)
   - `class*="card"` или `class*="Card"`

3. Проверьте, что элементы:
   - Видимы на странице
   - Содержат текстовые значения (названия и числа)
   - Не скрыты через CSS (`display: none`, `visibility: hidden`)

### Шаг 5: Проверьте консоль на ошибки
1. Перейдите на вкладку **Console**
2. Проверьте наличие ошибок:
   - Ошибки загрузки данных
   - Ошибки рендеринга компонентов
   - Ошибки API запросов

**Критичные ошибки:**
- `Failed to fetch` - проблема с сетью или CORS
- `Cannot read property` - проблема с данными
- `TypeError` - проблема с типами данных

## E2E тесты (Playwright)

### Запуск тестов:
```bash
npm run test:e2e -- e2e/kpi-cards-display.spec.ts
```

### Что проверяют тесты:
1. **Отображение карточек:**
   - Наличие элементов с `data-component-type="card"`
   - Наличие конкретных KPI (`capital_card`, `roa_card`, `roe_card`)
   - Наличие значений в карточках

2. **Загрузка данных:**
   - Запросы к `/api/data?query_id=kpis`
   - Корректность ответов API
   - Структура данных

3. **Ошибки:**
   - Отсутствие ошибок в консоли
   - Отсутствие ошибок сети

## Ручная проверка

### Проверка через curl:
```bash
# Проверка старого endpoint
curl -s "http://localhost:3001/api/kpis" | jq 'length'

# Проверка нового endpoint
curl -s "http://localhost:3001/api/data?query_id=kpis&component_Id=kpis&parametrs=%7B%22layout_id%22%3A%22main_dashboard%22%2C%22p1%22%3A%222025-12-31%22%2C%22p2%22%3A%222025-11-30%22%2C%22p3%22%3A%222024-12-31%22%7D" | jq 'length'
```

### Проверка в браузере:
1. Откройте `http://localhost:8080`
2. Проверьте визуально:
   - Видны ли карточки на странице?
   - Есть ли в них значения?
   - Правильно ли они отформатированы?

## Типичные проблемы

### Проблема 1: Карточки не отображаются

**Симптомы:**
- На странице нет элементов с `data-component-type="card"`
- В Network нет запросов к `/api/data?query_id=kpis`

**Возможные причины:**
1. Frontend не вызывает `useAllKPIs` hook
2. Данные не загружаются из-за ошибки API
3. Компоненты не рендерятся из-за ошибки в коде

**Решение:**
1. Проверить консоль на ошибки
2. Проверить Network на запросы к API
3. Проверить код компонента `DynamicDashboard.tsx`

### Проблема 2: Карточки пустые

**Симптомы:**
- Карточки видны, но без значений
- В консоли ошибки типа "Cannot read property 'value'"

**Возможные причины:**
1. API возвращает пустой массив
2. Формат данных не соответствует ожидаемому
3. Проблема с преобразованием данных

**Решение:**
1. Проверить Response в Network
2. Проверить логи в консоли
3. Проверить код `fetchAllKPIs` в `src/lib/api.ts`

### Проблема 3: Не все карточки отображаются

**Симптомы:**
- Отображается только часть карточек (например, 2 из 3)

**Возможные причины:**
1. API возвращает не все данные (например, отсутствует `roe_card`)
2. Фильтрация в компоненте исключает некоторые карточки

**Решение:**
1. Проверить количество элементов в Response
2. Проверить, какие `id` присутствуют в ответе
3. Сравнить со старым endpoint `/api/kpis`

## Созданные файлы

1. ✅ `e2e/kpi-cards-display.spec.ts` - E2E тесты для проверки отображения карточек
2. ✅ `test-kpi-cards-display.sh` - bash скрипт для быстрой проверки
3. ✅ `HOW_TO_TEST_KPI_CARDS.md` - это руководство

## Быстрая команда для проверки

```bash
# Проверка API
curl -s "http://localhost:3001/api/data?query_id=kpis&component_Id=kpis&parametrs=%7B%22layout_id%22%3A%22main_dashboard%22%2C%22p1%22%3A%222025-12-31%22%2C%22p2%22%3A%222025-11-30%22%2C%22p3%22%3A%222024-12-31%22%7D" | jq 'if type == "array" then "✅ \(length) карточек: \(map(.id) | join(", "))" else "❌ Ошибка: \(.error // .)" end'
```
