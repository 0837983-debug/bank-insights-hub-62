# Финальный отчет: QA — KPI через `/api/data`

**Дата:** 2026-01-20
**Статус:** ✅ Endpoint работает, но есть расхождения

## Результаты проверки после исправления

### 1. Старый endpoint `/api/kpis` ✅
- ✅ Работает корректно
- ✅ Возвращает массив из **3 элементов**
- ✅ Структура данных корректна

### 2. Новый endpoint `/api/data?query_id=kpis` ✅
- ✅ **Работает без ошибок!**
- ✅ Возвращает массив из **2 элементов**
- ✅ Структура данных совпадает со старым endpoint
- ⚠️ **Расхождение:** Количество элементов отличается (3 vs 2)

### 3. Сравнение структуры данных ✅

**Поля совпадают:**
- ✅ `id` - идентификатор KPI
- ✅ `periodDate` - дата периода
- ✅ `value` - текущее значение
- ✅ `previousValue` - предыдущее значение
- ✅ `ytdValue` - значение на начало года
- ✅ `ppChange` - изменение к предыдущему периоду (в долях)
- ✅ `ppChangeAbsolute` - абсолютное изменение к предыдущему периоду
- ✅ `ytdChange` - изменение к началу года (в долях)
- ✅ `ytdChangeAbsolute` - абсолютное изменение к началу года

**Структура полностью совпадает!** ✅

### 4. Сравнение значений ⚠️

**Старый endpoint (`/api/kpis`):**
- Возвращает 3 элемента: `capital_card`, `roa_card`, `ebitda_card` (предположительно)
- Значения для `capital_card`: `value: 11200000000`

**Новый endpoint (`/api/data?query_id=kpis`):**
- Возвращает 2 элемента: `capital_card`, `roa_card` (предположительно)
- Значения для `capital_card`: `value: 22400000000` (в 2 раза больше!)

**Расхождения:**
1. ⚠️ Количество элементов: 3 vs 2 (возможно, `ebitda_card` отсутствует в новом endpoint)
2. ⚠️ Значения отличаются: `value` в новом endpoint в 2 раза больше (возможно, проблема с агрегацией)

### 5. Проверка Frontend ⚠️

**Текущее состояние:**
- Frontend использует старый endpoint `/api/kpis` через `fetchAllKPIs` в `src/lib/api.ts`
- Функция `fetchAllKPIs` вызывает `apiFetch<KPIMetric[]>("/kpis")`
- Frontend еще не переведен на новый endpoint `/api/data?query_id=kpis`

## Обнаруженные расхождения

### Расхождение 1: Количество элементов ⚠️

**Ожидаемый результат:**
- Новый endpoint должен возвращать то же количество элементов, что и старый (3 элемента)

**Фактический результат:**
- Старый endpoint: 3 элемента
- Новый endpoint: 2 элемента

**Возможные причины:**
1. `ebitda_card` отсутствует в `config.kpis_view` для `layout_id = "main_dashboard"`
2. Фильтрация в view исключает один из компонентов
3. Проблема с join в view `config.kpis_view`

### Расхождение 2: Значения отличаются ⚠️

**Ожидаемый результат:**
- Значения должны совпадать между старым и новым endpoint

**Фактический результат:**
- `capital_card.value` в новом endpoint: `22400000000`
- `capital_card.value` в старом endpoint: `11200000000`
- Разница: в 2 раза больше

**Возможные причины:**
1. Проблема с агрегацией в SQL (возможно, дублирование данных)
2. Неправильная группировка в view
3. Проблема с join в view `config.kpis_view`

## Рекомендации

### Для Backend:
1. ⚠️ **Проверить количество элементов:**
   - Убедиться, что все 3 KPI карточки присутствуют в `config.kpis_view` для `layout_id = "main_dashboard"`
   - Проверить фильтрацию в view

2. ⚠️ **Проверить значения:**
   - Убедиться, что агрегация работает корректно
   - Проверить, нет ли дублирования данных в view
   - Сравнить SQL запросы старого и нового endpoint

3. **После исправления:**
   - Повторить сравнение ответов
   - Убедиться, что структура и значения полностью совпадают

### Для Frontend:
1. ⏸️ **Ожидает исправления Backend:** После исправления расхождений:
   - Обновить `fetchAllKPIs` для использования `/api/data?query_id=kpis`
   - Получать даты периодов из `header_dates` для параметров `p1`, `p2`, `p3`
   - Преобразовывать формат ответа (если нужно)

## Файлы

### Созданные файлы:
- ✅ `e2e/kpis-data-endpoint.spec.ts` - тесты для сравнения старого и нового endpoint
- ✅ `AGENT_PLAN_KPIS_DATA_QA_REPORT.md` - первоначальный отчет
- ✅ `AGENT_PLAN_KPIS_DATA_QA_REPORT_UPDATE.md` - обновление после первой проверки
- ✅ `AGENT_PLAN_KPIS_DATA_QA_REPORT_FINAL.md` - финальный отчет

## Заключение

✅ **Endpoint работает без SQL ошибок!**
⚠️ **Обнаружены расхождения:**
- Количество элементов: 3 vs 2
- Значения отличаются (в 2 раза)

**Следующие шаги:**
1. Backend должен проверить и исправить расхождения
2. После исправления повторить сравнение ответов
3. После успешной проверки Frontend может перейти на новый endpoint
