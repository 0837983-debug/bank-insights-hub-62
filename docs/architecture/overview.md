---
title: Общая архитектура
description: Обзор архитектуры системы Bank Insights Hub
related:
  - /architecture/frontend
  - /architecture/backend
  - /architecture/database
  - /architecture/data-flow
---

# Общая архитектура

Bank Insights Hub построен как full-stack приложение с четким разделением на слои и использованием современных паттернов разработки.

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                      Frontend Layer                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   React UI   │  │ React Query │  │   Routing    │     │
│  │  Components  │  │   (State)   │  │  (Router)    │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                  │             │
│         └─────────────────┴──────────────────┘             │
│                            │                               │
│                    ┌────────▼────────┐                     │
│                    │   API Client    │                     │
│                    │  (lib/api.ts)   │                     │
│                    └────────┬────────┘                     │
└──────────────────────────────┼─────────────────────────────┘
                               │ HTTP/REST API
                               │ (JSON)
┌──────────────────────────────▼─────────────────────────────┐
│                      Backend Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │    Routes    │  │   Services   │  │  Middleware  │     │
│  │  (Express)   │  │  (Business   │  │  (Error      │     │
│  │              │  │   Logic)     │  │   Handler)   │     │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘     │
│         │                 │                                │
│         └─────────────────┘                                │
│                            │                               │
│                    ┌────────▼────────┐                     │
│                    │  Data Mart      │                     │
│                    │   Services      │                     │
│                    └────────┬────────┘                     │
└──────────────────────────────┼─────────────────────────────┘
                               │ SQL Queries
                               │
┌──────────────────────────────▼─────────────────────────────┐
│                    Database Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  dashboard   │  │    config    │  │     mart     │     │
│  │   schema     │  │   schema     │  │   schema     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│                    PostgreSQL Database                      │
└─────────────────────────────────────────────────────────────┘
```

## Основные компоненты

### Frontend (React + TypeScript)

- **UI Layer**: React компоненты с использованием shadcn/ui
- **State Management**: React Query для кэширования и синхронизации данных
- **Routing**: React Router для навигации
- **Styling**: Tailwind CSS для стилизации
- **Build Tool**: Vite для быстрой разработки и сборки

### Backend (Node.js + Express)

- **API Layer**: Express routes для обработки HTTP запросов
- **Service Layer**: Бизнес-логика в сервисах
- **Data Access**: Прямые SQL запросы к PostgreSQL
- **Data Mart**: Агрегированные данные для быстрого доступа

### Database (PostgreSQL)

- **Multiple Schemas**: Разделение данных по схемам
- **Data Mart**: Оптимизированные таблицы для чтения
- **Config Schema**: Метаданные и конфигурация layout

## Архитектурные паттерны

### 1. Service Layer Pattern

Бизнес-логика вынесена в отдельные сервисы:

```
Routes → Services → Database
```

**Преимущества:**
- Разделение ответственности
- Переиспользование логики
- Легкое тестирование

### 2. Data Mart Pattern

Агрегированные данные хранятся в отдельной схеме `mart`:

```
Raw Data → Data Mart → API
```

**Преимущества:**
- Быстрый доступ к данным
- Оптимизированные запросы
- Разделение чтения и записи

### 3. Configuration-Driven UI

Структура UI определяется конфигурацией из БД:

```
Database Config → Layout Service → Frontend Components
```

**Преимущества:**
- Динамическая структура дашборда
- Изменения без передеплоя
- Гибкость настройки

### 4. RESTful API

Стандартизированный REST API:

- `GET /api/kpis` - получение KPI метрик
- `GET /api/table-data/:tableId` - получение данных таблиц
- `GET /api/layout` - получение структуры layout

## Принципы проектирования

### 1. Separation of Concerns

Каждый слой отвечает за свою область:
- Frontend - представление и взаимодействие
- Backend - бизнес-логика и валидация
- Database - хранение данных

### Концепция обработки данных

Проект следует принципу **минимальной обработки данных на фронтенде**.

**Backend выполняет:**
- Все расчеты метрик (ppChange, ytdChange, percentage)
- Агрегацию данных из БД
- Формирование плоских строк с иерархией

**Frontend выполняет:**
- Форматирование данных для отображения (`formatValue`)
- Построение иерархической структуры UI из плоских данных
- Пересчет метрик для групп (исключение для агрегации групп в UI)

**Преимущества:**
- Меньше нагрузки на клиент
- Единый источник истины для расчетов (backend)
- Упрощение frontend логики
- Возможность кэширования на уровне API

### 2. Single Responsibility

Каждый модуль/сервис решает одну задачу:
- `layoutService` (config) - построение layout из config схемы
- `kpiService` (mart) - работа с KPI метриками из mart схемы
- `balanceService` (mart) - работа с балансом из mart схемы

### 3. DRY (Don't Repeat Yourself)

Переиспользование кода через:
- Общие сервисы
- Утилиты и хелперы
- Типизированные интерфейсы

### 4. Type Safety

TypeScript используется везде:
- Строгая типизация API
- Типизированные модели данных
- Проверка типов на этапе компиляции

## Технологический стек

### Frontend

- **React 18** - UI библиотека с современными хуками
- **TypeScript** - типизация для надежности кода
- **Vite** - быстрый сборщик и dev сервер
- **Tailwind CSS** - utility-first CSS фреймворк
- **shadcn/ui** - компоненты на основе Radix UI
- **React Query** - управление серверным состоянием

### Backend

- **Node.js** - JavaScript runtime
- **Express** - минималистичный web framework
- **TypeScript** - типизация для надежности
- **PostgreSQL** - реляционная база данных
- **pg** - PostgreSQL клиент для Node.js

### Инструменты разработки

- **Vitest** - unit тестирование
- **Playwright** - E2E тестирование
- **ESLint** - линтинг кода
- **Prettier** - форматирование кода

## Поток данных

1. **Пользователь** взаимодействует с UI
2. **React компонент** вызывает hook (useAPI)
3. **React Query** проверяет кэш и делает запрос
4. **API Client** отправляет HTTP запрос
5. **Backend Route** обрабатывает запрос
6. **Service** выполняет бизнес-логику
7. **Database** возвращает данные
8. **Service** трансформирует данные
9. **Route** возвращает JSON ответ
10. **Frontend** обновляет UI

Подробнее в разделе [Поток данных](/architecture/data-flow).

## Масштабируемость

### Горизонтальное масштабирование

- Frontend: статические файлы, легко масштабируется через CDN
- Backend: stateless API, можно запускать несколько инстансов
- Database: репликация для чтения, шардирование при необходимости

### Вертикальное масштабирование

- Оптимизация запросов к БД
- Кэширование на уровне React Query
- Data Mart для быстрого доступа к агрегированным данным

## Безопасность

- **CORS** настроен для разрешенных доменов
- **Input Validation** на уровне routes
- **SQL Injection Protection** через параметризованные запросы
- **Error Handling** без утечки чувствительной информации

## См. также

- [Frontend архитектура](/architecture/frontend) - детали frontend
- [Backend архитектура](/architecture/backend) - детали backend
- [База данных](/architecture/database) - структура БД
- [Поток данных](/architecture/data-flow) - детальный поток данных
