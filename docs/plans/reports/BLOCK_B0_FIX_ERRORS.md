# Отчёт об ошибках QA: Блок B.0 FIX — Повторная проверка после исправлений

**Дата**: 2026-01-26  
**Ответственный**: QA Agent  
**Статус**: ❌ Обнаружена проблема с валидацией отрицательных значений

---

## Выполненные проверки

### 1. Проверка исправлений в коде

#### ✅ fileParserService.ts
- ✅ Функция `getRowValue` создана и экспортирована
- ✅ Функция реализует case-insensitive поиск полей в объекте `row`
- ✅ Код:
  ```typescript
  export function getRowValue(row: ParsedRow, fieldName: string): string | number | null | undefined {
    // Сначала пробуем точное совпадение (для обратной совместимости)
    if (fieldName in row) {
      return row[fieldName];
    }
    // Ищем поле без учёта регистра
    const key = Object.keys(row).find(k => k.toLowerCase() === fieldName.toLowerCase());
    return key ? row[key] : undefined;
  }
  ```

#### ✅ validationService.ts
- ✅ Использует `getRowValue` для получения значений полей
- ✅ Заменено `row[map.sourceField]` на `getRowValue(row, map.sourceField)`

#### ✅ ingestionService.ts
- ✅ Использует `getRowValue` для получения значений полей
- ✅ Заменено прямое обращение к полям на `getRowValue`

#### ✅ uploadRoutes.ts
- ✅ Использует `getRowValue` для получения значений полей
- ✅ Использует уже полученный `fieldMapping` вместо повторного запроса

---

### 2. Попытка загрузки тестового файла

**Команда**:
```bash
curl -X POST "http://localhost:3001/api/upload" \
  -F "file=@/Users/pm/bin/files4upload/Balance/Средний баланс декабрь 2024 -- декабрь 2025.xlsx" \
  -F "targetTable=balance" \
  -F "sheetName=Лист1"
```

**Результат**: Upload ID 55, статус `failed`

**Ошибки валидации**:
```json
{
  "uploadId": 55,
  "status": "failed",
  "validationErrors": {
    "totalCount": 198,
    "byType": {
      "value_too_small": 198
    },
    "examples": [
      {
        "type": "value_too_small",
        "field": "amount",
        "message": "Значение меньше минимального (min: 0)"
      }
    ]
  }
}
```

---

### 3. Анализ проблемы

#### ✅ Что работает:
1. **Case-insensitive обращение к полям** - ✅ Работает
   - Поля находятся корректно (`Month`, `Class`, `Amount` → `month`, `class`, `amount`)
   - Валидация структуры файла проходит успешно
   - Поля читаются из объекта `row` корректно

2. **Парсинг файла** - ✅ Работает
   - Заголовки распознаны: `['Class', 'Section', 'Item', 'Amount', 'Month']`
   - Даты распознаны корректно: `2024-12-01`
   - Значения парсятся как числа (включая отрицательные)

#### ❌ Обнаруженная проблема:

**Проблема: Валидация отклоняет отрицательные значения для поля `amount`**

**Детали**:
- **Validation rules в mapping**: `{ "min": 0 }` для поля `amount` → `value`
- **Значения в файле**: 198 строк содержат отрицательные значения для `Amount`
- **Примеры отрицательных значений**:
  - `-3757469`
  - `-5315961.06451613`
  - `-78685`
  - `-1190966.29032258`
  - и т.д.

**Анализ данных из файла**:
```
=== Первые 10 строк ===
Строка 1: Amount: -3757469 (number)
Строка 2: Amount: -5315961.06451613 (number)
Строка 3: Amount: -78685 (number)
...
Строка 17: Amount: 5904383.41935484 (number)  ← положительное значение
Строка 18: Amount: 9387025.35483871 (number)  ← положительное значение
...

=== Строк с amount <= 0: 198 ===
```

**Вывод**: 
- В файле есть как отрицательные, так и положительные значения
- 198 строк содержат отрицательные или нулевые значения
- Валидация корректно определяет, что эти значения меньше `min: 0`
- **Вопрос**: Должны ли отрицательные значения быть разрешены для баланса?

---

### 4. Проверка validation rules в БД

**Запрос**:
```sql
SELECT source_field, target_field, field_type, is_required, validation_rules
FROM dict.upload_mappings
WHERE target_table = 'balance' AND target_field = 'value'
```

**Результат**:
- `source_field`: `amount`
- `target_field`: `value`
- `field_type`: `numeric`
- `is_required`: `true`
- `validation_rules`: `{ "min": 0 }`

**Вывод**: Validation rules требуют, чтобы значение было >= 0, но в файле есть отрицательные значения.

---

## Проблема

### Суть проблемы:

**Валидация отклоняет отрицательные значения для поля `amount`, хотя они присутствуют в файле.**

### Детали:

1. **Validation rules**: `{ "min": 0 }` для поля `amount`
2. **Данные в файле**: 198 строк содержат отрицательные значения
3. **Результат**: Все 198 строк отклоняются валидацией

### Вопросы для уточнения:

1. **Должны ли отрицательные значения быть разрешены для баланса?**
   - Если да → нужно убрать или изменить `min: 0` в validation_rules
   - Если нет → файл содержит некорректные данные

2. **Могут ли быть отрицательные значения в балансе?**
   - Для некоторых статей баланса (например, обязательства, резервы) отрицательные значения могут быть некорректными
   - Для других статей (например, убытки, корректировки) отрицательные значения могут быть допустимы

3. **Как должны обрабатываться отрицательные значения?**
   - Разрешить отрицательные значения (убрать `min: 0`)
   - Или изменить логику валидации для разных типов статей

---

## Рекомендации

### Вариант 1: Разрешить отрицательные значения

Если отрицательные значения допустимы для баланса:
1. Убрать `min: 0` из `validation_rules` для поля `amount` в `dict.upload_mappings`
2. Или установить `min: null` или не указывать `min` вообще

**SQL для исправления**:
```sql
UPDATE dict.upload_mappings
SET validation_rules = '{}'::jsonb  -- или '{"max": null}' если нужен только max
WHERE target_table = 'balance' AND target_field = 'value';
```

### Вариант 2: Проверить данные в файле

Если отрицательные значения недопустимы:
1. Проверить файл на корректность данных
2. Возможно, отрицательные значения должны быть положительными (абсолютное значение)
3. Или файл содержит ошибки, которые нужно исправить

### Вариант 3: Условная валидация

Если для разных статей нужны разные правила:
1. Добавить проверку типа статьи (class, section)
2. Применять разные validation_rules в зависимости от типа статьи
3. Это требует изменения логики валидации

---

## Статус проверки

### ✅ Что исправлено и работает:

1. ✅ **Case-insensitive обращение к полям** - работает корректно
2. ✅ **Динамическое получение заголовков из mapping** - работает
3. ✅ **Парсинг файла** - работает корректно
4. ✅ **Распознавание дат** - работает корректно (`2024-12-01`)

### ❌ Что не работает:

1. ❌ **Валидация отрицательных значений** - отклоняет 198 строк с отрицательными значениями
2. ❌ **Загрузка данных в БД** - не выполняется из-за ошибок валидации

---

## Выводы

1. **Исправления Backend Agent применены корректно**:
   - ✅ Функция `getRowValue` работает
   - ✅ Case-insensitive обращение к полям работает
   - ✅ Поля находятся и читаются корректно

2. **Новая проблема**: Валидация отклоняет отрицательные значения
   - Это не ошибка в коде, а проблема с бизнес-логикой валидации
   - Нужно решить: разрешены ли отрицательные значения для баланса?

3. **Требуется решение**:
   - Либо изменить validation_rules (убрать `min: 0`)
   - Либо проверить корректность данных в файле
   - Либо реализовать условную валидацию для разных типов статей

---

## Следующие шаги

### Для Backend Agent (если отрицательные значения допустимы):

1. **Изменить validation_rules в БД**:
   ```sql
   UPDATE dict.upload_mappings
   SET validation_rules = '{}'::jsonb
   WHERE target_table = 'balance' AND target_field = 'value';
   ```

2. **Или изменить логику валидации** для разрешения отрицательных значений

### Для QA Agent (после исправления):

1. ⏳ Повторить загрузку файла
2. ⏳ Проверить, что данные попадают в STG/ODS/MART
3. ⏳ Убедиться, что отрицательные значения обрабатываются корректно

---

## Примечания

- Код исправлен правильно, case-insensitive обращение к полям работает
- Проблема не в коде, а в бизнес-логике валидации
- Требуется решение о допустимости отрицательных значений для баланса
