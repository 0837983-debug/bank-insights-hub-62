# –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: KPICard –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ calculated –ø–æ–ª–µ–π

> **–°–æ–∑–¥–∞–Ω**: 2026-02-04  
> **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
> **Roadmap**: H.5 ‚Äî –¢–∏–ø–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π + Calculated fields

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

KPICard —Å–µ–π—á–∞—Å –∂—ë—Å—Ç–∫–æ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–ª—è `ppChange/ytdChange` –∏ –∏—Ö —Ñ–æ—Ä–º–∞—Ç–Ω—ã–µ –ø–æ–¥–∫–æ–ª–æ–Ω–∫–∏. –í layout –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥—Ä—É–≥–∏–µ id (–Ω–∞–ø—Ä–∏–º–µ—Ä, `p2Change`, `p3Change`), –ø–æ—ç—Ç–æ–º—É calculated –∑–Ω–∞—á–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å calculated –ø–æ–ª—è —Å—Ç—Ä–æ–≥–æ –ø–æ layout.

**–§–∞–π–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:**
- `docs/context/frontend.md`
- `src/components/KPICard.tsx`
- `src/lib/calculations.ts`

---

## –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ: –≤–∞—Ä–∏–∞–Ω—Ç A)

**–í–∞—Ä–∏–∞–Ω—Ç A (–≤—ã–±—Ä–∞–Ω):**  
–†–µ–Ω–¥–µ—Ä–∏—Ç—å calculated sub_columns –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ layout:  
1) —Å–æ–±—Ä–∞—Ç—å `sub_columns` —Å `fieldType === 'calculated'`  
2) –ø–æ—Å—á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ `executeCalculation`  
3) –≤—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É layout  
4) toggle ‚Äú% / –∞–±—Å–æ–ª—é—Ç‚Äù ‚Äî –≤—ã–±–∏—Ä–∞—Ç—å –Ω–∞–±–æ—Ä –ø–æ `format.kind` (percent vs not percent) —á–µ—Ä–µ–∑ `layout.formats`

**–í–∞—Ä–∏–∞–Ω—Ç B (–Ω–µ –≤—ã–±—Ä–∞–Ω):**  
–û—Å—Ç–∞–≤–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 2 —Å—Ç—Ä–æ–∫–∏, –Ω–æ –∫–æ–Ω—Ñ–∏–≥–æ–º –∑–∞–¥–∞–≤–∞—Ç—å id ‚Äúprimary/secondary‚Äù. –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥–∞.

---

## ‚õî –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)

### –ó–ê–ü–†–ï–©–ï–ù–û:
- **Backward compatibility –∫–æ—Å—Ç—ã–ª–∏**
- **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã**
- **–•–∞—Ä–¥–∫–æ–¥ –∏–º—ë–Ω –ø–æ–ª–µ–π**
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤**

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- –û–¥–∏–Ω –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ layout)
- –£–¥–∞–ª—è—Ç—å deprecated –ª–æ–≥–∏–∫—É
- –ß–∏—Å—Ç—ã–π –∫–æ–¥ –±–µ–∑ ¬´–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö¬ª –±–ª–æ–∫–æ–≤

---

## –≠—Ç–∞–ø 1: Frontend ‚úÖ

**–°—É–±–∞–≥–µ–Ω—Ç**: `frontend-agent`  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –ù–µ—Ç  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

### –ó–∞–¥–∞—á–∏:
- [x] –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ `ppChange/ytdChange` –∏–∑ `KPICard`
- [x] –°–æ–±–∏—Ä–∞—Ç—å calculated –ø–æ–ª—è –∏–∑ `columns[].sub_columns` –ø–æ `fieldType === 'calculated'`
- [x] –î–ª—è –∫–∞–∂–¥–æ–≥–æ calculated –ø–æ–ª—è –≤—ã—á–∏—Å–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `executeCalculation(calculationConfig, kpi)`
- [x] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ `formatValue` –∏—Å–ø–æ–ª—å–∑—É—è `sub_column.format`
- [x] –†–µ–Ω–¥–µ—Ä–∏—Ç—å calculated –ø–æ–ª—è –≤ UI **–ø–æ –ø–æ—Ä—è–¥–∫—É layout**
- [x] Toggle `%/–∞–±—Å.`:
  - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —Å `format.kind === 'percent'` –∏ `format.kind !== 'percent'`
  - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `showAbsolute`
  - –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ—ë –∏ —Å–∫—Ä—ã—Ç—å toggle
- [x] –£–¥–∞–ª–∏—Ç—å fallback –∫–æ–Ω—Ñ–∏–≥–∏ –∏ –ª—é–±—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã –¥–ª—è calculated –ø–æ–ª–µ–π
- [x] –û–±–Ω–æ–≤–∏—Ç—å `docs/context/frontend.md`

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `src/components/KPICard.tsx`
- (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) `src/lib/api.ts` ‚Äî —Ç–∏–ø—ã –¥–ª—è layout formats

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
- [x] –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞ –∏–º—ë–Ω –ø–æ–ª–µ–π (ppChange/ytdChange –∏ —Ç.–ø.)
- [x] Calculated –ø–æ–ª—è –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ layout
- [x] `npm run build` –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] KPI –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ id –∏–∑ layout (`p2Change`, `p3Change`, ...)

### üìã –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è Executor (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Task tool!):

```javascript
Task(
  subagent_type: "frontend-agent",
  description: "KPICard: calculated –ø–æ–ª—è –∏–∑ layout –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞",
  prompt: `
    –ü–ï–†–ï–î –ù–ê–ß–ê–õ–û–ú –†–ê–ë–û–¢–´:
    1. –ü—Ä–æ—á–∏—Ç–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: docs/context/frontend.md
    2. –ü—Ä–æ—á–∏—Ç–∞–π –ø–ª–∞–Ω: docs/plans/current/KPICARD_DYNAMIC_CALCULATED_FIELDS.md
    3. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ñ–∞–π–ª—ã —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –ø–ª–∞–Ω–µ

    ‚õî –ó–ê–ü–†–ï–©–ï–ù–û:
    - –•–∞—Ä–¥–∫–æ–¥–∏—Ç—å –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π
    - –û—Å—Ç–∞–≤–ª—è—Ç—å fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
    - –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç—ã

    –í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á–∏ –≠—Ç–∞–ø–∞ 1.

    –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
    - –ü—Ä–æ–≤–µ—Ä—å —Å–±–æ—Ä–∫—É: npm run build
    - –û–±–Ω–æ–≤–∏ docs/context/frontend.md
    - –û–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç—É—Å —ç—Ç–∞–ø–∞ –≤ –ø–ª–∞–Ω–µ –Ω–∞ ‚úÖ
  `
)
```

---

## –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# Frontend —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
npm run build
```

---

## –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –î–∞—Ç–∞ | –≠—Ç–∞–ø | –†–µ–∑—É–ª—å—Ç–∞—Ç | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|------|-----------|-------------|
| 2026-02-04 | Frontend | ‚úÖ | –£–±—Ä–∞–Ω —Ö–∞—Ä–¥–∫–æ–¥ ppChange/ytdChange, calculated –ø–æ–ª—è –±–µ—Ä—É—Ç—Å—è –∏–∑ layout, toggle —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ format.kind |
