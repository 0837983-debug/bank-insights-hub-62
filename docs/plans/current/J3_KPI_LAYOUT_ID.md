# –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –î–æ–±–∞–≤–∏—Ç—å layout_id –≤ v_kpi_all –∏ —Å–≤—è–∑–∞—Ç—å —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏

> **–°–æ–∑–¥–∞–Ω**: 2026-01-23  
> **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω  
> **Roadmap**: `docs/plans/ROADMAP.md` ‚Äî J.3

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

KPI –¥–æ–ª–∂–Ω—ã –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç layout. –°–µ–π—á–∞—Å `mart.v_kpi_all` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `layout_id`, –ø–æ—ç—Ç–æ–º—É –Ω–µ–ª—å–∑—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å KPI –ø–æ –¥–∞—à–±–æ—Ä–¥—É.  
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `layout_id` –≤ `v_kpi_all` —á–µ—Ä–µ–∑ join –Ω–∞ `config.components` –∏ `config.layout_component_mapping`, —á—Ç–æ–±—ã `kpis` query –º–æ–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ `layout_id`.

**–§–∞–π–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:**
- `docs/context/database.md`
- `docs/context/backend.md`
- `docs/plans/current/J3_QUERY_ID_AND_KPI_MAPPING.md` (–µ—Å–ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è)

---

## –≠—Ç–∞–ø 1: Backend ‚úÖ

**–°—É–±–∞–≥–µ–Ω—Ç**: `backend-agent`  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –ù–µ—Ç  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω

### –ó–∞–¥–∞—á–∏:
- [x] –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `mart.v_kpi_all` (–º–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).
- [x] –°–æ–∑–¥–∞—Ç—å SQL‚Äë–º–∏–≥—Ä–∞—Ü–∏—é: –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å `mart.v_kpi_all` —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º `layout_id`.
- [x] –î–æ–±–∞–≤–∏—Ç—å join:
  - `mart.v_kpi_all` ‚Üí `config.components` (–ø–æ `data_source_key = kpi_name`, —Ç–æ–ª—å–∫–æ `component_type='card'`).
  - `config.components` ‚Üí `config.layout_component_mapping` (–ø–æ `component_id`) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `layout_id`.
- [x] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö layout —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.
- [x] –û–±–Ω–æ–≤–∏—Ç—å `docs/context/database.md` –∏ `docs/context/backend.md`.

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `backend/src/migrations/0xx_update_v_kpi_all_add_layout_id.sql`
- `docs/context/database.md`
- `docs/context/backend.md`

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
- [ ] `mart.v_kpi_all` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `layout_id` –∏ `component_id`.
- [ ] –ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å `SELECT * FROM mart.v_kpi_all WHERE layout_id = 'main_dashboard'`.
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫.

### üìã –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è Executor (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Task tool!):

```javascript
Task(
  subagent_type: "backend-agent",
  description: "Add layout_id to v_kpi_all view",
  prompt: `
    –ü—Ä–æ—á–∏—Ç–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: docs/context/backend.md, docs/context/database.md
    –ü—Ä–æ—á–∏—Ç–∞–π –ø–ª–∞–Ω: docs/plans/current/J3_KPI_LAYOUT_ID.md, —Ä–∞–∑–¥–µ–ª "–≠—Ç–∞–ø 1: Backend"
    
    –í—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞.
    
    –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
    - –ü—Ä–æ–≤–µ—Ä—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é: cd backend && npm run build
    - –û–±–Ω–æ–≤–∏ docs/context/backend.md –∏ docs/context/database.md
    - –û–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç—É—Å —ç—Ç–∞–ø–∞ –≤ –ø–ª–∞–Ω–µ –Ω–∞ ‚úÖ
  `
)
```

---

## –≠—Ç–∞–ø 2: QA ‚úÖ

**–°—É–±–∞–≥–µ–Ω—Ç**: `qa-agent`  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –≠—Ç–∞–ø 1 ‚úÖ  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

### –ó–∞–¥–∞—á–∏:
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL‚Äë—Ñ–∏–ª—å—Ç—Ä –ø–æ `layout_id` (—Ä—É—á–Ω–æ–π –∑–∞–ø—Ä–æ—Å).
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `kpis` query –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ layout.

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `docs/plans/reports/QA_KPI_LAYOUT_ID.md` (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏)

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
- [ ] `kpis` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ `layout_id`.
- [ ] –û—à–∏–±–æ–∫ `invalid params` –Ω–µ—Ç.

### üìã –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ Executor):

```
–ó–∞–ø—É—Å—Ç–∏ qa-agent:
- –ü—Ä–æ—á–∏—Ç–∞–π docs/plans/current/J3_KPI_LAYOUT_ID.md, —Ä–∞–∑–¥–µ–ª "–≠—Ç–∞–ø 2: QA"
- –ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ layout_id
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Äî –æ—Ñ–æ—Ä–º–∏ –æ—Ç—á—ë—Ç
```

---

## –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ Executor –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```bash
# Backend –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
cd backend && npm run build
```

---

## –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –î–∞—Ç–∞ | –≠—Ç–∞–ø | –†–µ–∑—É–ª—å—Ç–∞—Ç | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|------|-----------|-------------|
| 2026-02-09 | –≠—Ç–∞–ø 1: Backend | ‚úÖ | –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è 055_add_layout_id_to_v_kpi_all.sql. Build —É—Å–ø–µ—à–µ–Ω. |
