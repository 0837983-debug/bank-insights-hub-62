---
title: Загрузка файлов
description: Руководство по загрузке файлов (CSV/XLSX) для импорта данных
related:
  - /api/upload-api
  - /development/setup
---

# Загрузка файлов

Руководство по загрузке файлов (CSV/XLSX) для импорта данных в базу данных.

## Обзор

Система поддерживает загрузку данных из CSV и XLSX файлов для импорта в базу данных. Загрузка проходит через трехэтапный процесс: **STG → ODS → MART**.

**Поддерживаемые форматы:**
- **CSV** - файлы с разделителем `;` (точка с запятой)
- **XLSX** - файлы Excel 2007+

**Поддерживаемые таблицы:**
- `balance` - Баланс (активы, пассивы, капитал)

## Формат файлов

### CSV формат

**Разделитель:** `;` (точка с запятой)  
**Кодировка:** UTF-8  
**Заголовки:** первая строка содержит названия колонок

**Пример файла `balance.csv`:**
```csv
month;class;section;item;amount
2025-01-01;assets;loans;loans_retail;1000000
2025-01-01;assets;cash;cash_total;500000
2025-01-01;liabilities;deposits;deposits_corporate;2000000
2025-01-01;equity;capital;capital_total;1500000
```

### XLSX формат

**Формат:** Excel 2007+  
**Заголовки:** первая строка содержит названия колонок  
**Листы:** можно выбрать конкретный лист при загрузке

**Пример структуры XLSX файла:**

| month | class | section | item | amount |
|-------|-------|---------|------|--------|
| 2025-01-01 | assets | loans | loans_retail | 1000000 |
| 2025-01-01 | assets | cash | cash_total | 500000 |
| 2025-01-01 | liabilities | deposits | deposits_corporate | 2000000 |
| 2025-01-01 | equity | capital | capital_total | 1500000 |

## Структура данных (balance)

### Обязательные поля

- **`month`** (string) - Дата периода в формате `YYYY-MM-DD`
  - Пример: `2025-01-01`
  - Формат строго: ГГГГ-ММ-ДД (год-месяц-день)
  
- **`class`** (string) - Класс баланса
  - Возможные значения: `assets`, `liabilities`, `equity`
  - Обязательное поле
  
- **`amount`** (number) - Значение (сумма)
  - Числовое значение (может быть отрицательным)
  - Обязательное поле

### Опциональные поля

- **`section`** (string) - Раздел баланса
  - Примеры: `loans`, `cash`, `deposits`, `capital`
  - Опциональное поле
  
- **`item`** (string) - Статья баланса
  - Примеры: `loans_retail`, `cash_total`, `deposits_corporate`
  - Опциональное поле

### Примеры значений

**Классы (class):**
- `assets` - Активы
- `liabilities` - Обязательства (пассивы)
- `equity` - Собственный капитал

**Разделы (section):**
- `loans` - Кредиты
- `cash` - Денежные средства
- `deposits` - Депозиты
- `capital` - Капитал

## Процесс загрузки

### 1. Подготовка файла

**Проверьте перед загрузкой:**
- ✅ Формат файла: CSV с разделителем `;` или XLSX
- ✅ Кодировка: UTF-8
- ✅ Заголовки: первая строка содержит названия колонок
- ✅ Обязательные поля: `month`, `class`, `amount`
- ✅ Формат даты: `YYYY-MM-DD` (например, `2025-01-01`)
- ✅ Числовые значения: `amount` должен быть числом

### 2. Загрузка файла

**Через веб-интерфейс:**
1. Перейдите на страницу `/upload`
2. Выберите файл (CSV или XLSX)
3. Выберите целевую таблицу (`balance`)
4. Для XLSX файлов: выберите лист (опционально)
5. Нажмите "Загрузить"

**Через API:**
```bash
curl -X POST http://localhost:3001/api/upload \
  -F "file=@balance.csv" \
  -F "targetTable=balance"
```

### 3. Валидация

Система автоматически проверяет:
- **Структуру файла:** наличие обязательных заголовков
- **Формат даты:** корректность формата `YYYY-MM-DD`
- **Числовые значения:** корректность числовых полей
- **Обязательные поля:** заполненность обязательных полей
- **Уникальность:** отсутствие дубликатов записей

**При ошибках валидации:**
- Загрузка останавливается
- Отображаются примеры ошибок (1-2 примера каждой категории)
- Общее количество ошибок указывается отдельно

### 4. Обработка

После успешной валидации:
1. **Сохранение в STG** (`stg.balance_upload`)
2. **Трансформация в ODS** (`ods.balance`)
3. **Трансформация в MART** (`mart.balance`)

**Важно:** Старые данные за период будут **мягко удалены** (soft delete) перед загрузкой новых.

### 5. Результат

**Успешная загрузка:**
- Статус: `completed`
- Показывается количество обработанных строк
- Данные доступны в системе

**Ошибка загрузки:**
- Статус: `failed`
- Отображаются ошибки валидации
- Данные не загружены

## Типичные ошибки

### 1. Неверный формат даты

**Ошибка:**
```
Неверный формат даты: '2025-01'
```

**Причина:** Дата не в формате `YYYY-MM-DD`

**Решение:** Исправьте формат даты на `YYYY-MM-DD` (например, `2025-01-01`)

### 2. Отсутствуют обязательные поля

**Ошибка:**
```
Отсутствуют обязательные заголовки: month, class, amount
```

**Причина:** В файле отсутствуют обязательные колонки

**Решение:** Убедитесь, что в первой строке есть все обязательные заголовки

### 3. Неверный формат числа

**Ошибка:**
```
Значение не является числом: 'abc'
```

**Причина:** В поле `amount` указано не число

**Решение:** Исправьте значение на число (например, `1000000`)

### 4. Отсутствует обязательное поле

**Ошибка:**
```
Отсутствует обязательное поле: month
```

**Причина:** В строке отсутствует значение обязательного поля

**Решение:** Заполните все обязательные поля (`month`, `class`, `amount`)

### 5. Дубликат записи

**Ошибка:**
```
Дубликат записи: period_date=2025-01-01, class=assets, section=loans, item=loans_retail
```

**Причина:** В файле есть дубликаты записей с одинаковыми ключами

**Решение:** Удалите дубликаты или объедините значения

## Откат загрузки

Если вы загрузили данные по ошибке, вы можете откатить загрузку:

**Через веб-интерфейс:**
1. Перейдите на страницу истории загрузок
2. Найдите нужную загрузку
3. Нажмите "Откатить"

**Через API:**
```bash
POST /api/upload/1/rollback
```

**Что происходит при откате:**
- Данные удаляются из STG, ODS и MART
- Статус загрузки меняется на `rolled_back`
- Старые данные (если были) могут быть восстановлены

## История загрузок

Вы можете просмотреть историю всех загрузок:

**Через веб-интерфейс:**
- Страница истории загрузок показывает все загрузки
- Фильтрация по таблице и статусу

**Через API:**
```bash
GET /api/uploads
GET /api/uploads?targetTable=balance&status=completed
```

**Информация о загрузке:**
- ID загрузки
- Имя файла
- Статус (`pending`, `processing`, `completed`, `failed`, `rolled_back`)
- Количество обработанных строк
- Дата и время загрузки
- Ошибки валидации (если есть)

## Ограничения

- **Максимальный размер файла:** 50 MB
- **Форматы:** CSV (разделитель `;`), XLSX
- **Кодировка:** UTF-8
- **Формат даты:** `YYYY-MM-DD`

## Советы

### 1. Проверка файла перед загрузкой

**CSV:**
- Откройте файл в текстовом редакторе
- Убедитесь, что разделитель - `;`
- Проверьте формат даты

**XLSX:**
- Откройте файл в Excel
- Проверьте, что первая строка содержит заголовки
- Убедитесь, что данные корректны

### 2. Малые батчи

Для больших файлов рекомендуется разбивать на небольшие части (1000-5000 строк) для более быстрой обработки и удобства отладки.

### 3. Резервное копирование

Перед загрузкой новых данных рекомендуется сделать резервную копию существующих данных на случай необходимости отката.

### 4. Проверка результатов

После загрузки проверьте:
- Количество загруженных строк соответствует файлу
- Данные корректно отображаются в системе
- Нет дубликатов

## Примеры файлов

### Пример 1: Минимальный файл (balance)

**Файл `balance_minimal.csv`:**
```csv
month;class;amount
2025-01-01;assets;1000000
2025-01-01;liabilities;2000000
2025-01-01;equity;1500000
```

### Пример 2: Полный файл (balance)

**Файл `balance_full.csv`:**
```csv
month;class;section;item;amount
2025-01-01;assets;loans;loans_retail;1000000
2025-01-01;assets;loans;loans_corporate;500000
2025-01-01;assets;cash;cash_total;300000
2025-01-01;liabilities;deposits;deposits_retail;1500000
2025-01-01;liabilities;deposits;deposits_corporate;800000
2025-01-01;equity;capital;capital_total;1500000
```

### Пример 3: Несколько периодов

**Файл `balance_months.csv`:**
```csv
month;class;section;item;amount
2025-01-01;assets;loans;loans_retail;1000000
2025-02-01;assets;loans;loans_retail;1100000
2025-03-01;assets;loans;loans_retail;1200000
```

## См. также

- [Upload API](/api/upload-api) - детальное описание API загрузки
- [Все Endpoints](/api/endpoints) - полный список API endpoints
- [Настройка окружения](/development/setup) - информация о настройке
