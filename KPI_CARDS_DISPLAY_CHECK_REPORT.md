# Отчет: Проверка отображения KPI карточек на фронтенде

**Дата:** 2026-01-20
**Статус:** ⚠️ Частичное отображение карточек

## Результаты проверки

### 1. API endpoint `/api/data?query_id=kpis` ✅
- ✅ Работает без ошибок
- ✅ Возвращает **2 элемента**: `capital_card`, `roa_card`
- ✅ Структура данных корректна

### 2. Компоненты в layout ⚠️
- ✅ Найдено **4 карточки** в layout для `main_dashboard`:
  - `capital_card` (Капитал) - **2 раза** (дублирование!)
  - `roa_card` (ROA)
  - `ebitda_card` (EBITDA)

### 3. Данные в mart.kpi_metrics ✅
- ✅ Найдено **4 компонента** с данными:
  - `capital_card`
  - `roa_card`
  - `roe_card`
  - `total_assets_card`

### 4. Сравнение: что должно отображаться ⚠️

**Должны отображаться (есть и в layout, и в данных):**
- ✅ `capital_card` - **должна отображаться** (есть в layout и в данных)
- ✅ `roa_card` - **должна отображаться** (есть в layout и в данных)

**Проблемы:**
- ⚠️ `ebitda_card` - есть в layout, но **нет данных** в `mart.kpi_metrics`
- ⚠️ `roe_card` - есть данные, но **нет в layout** для `main_dashboard`
- ⚠️ `capital_card` - **дублируется** в layout (2 записи)

### 5. View `config.kpis_view` ❌
- ❌ View не существует: `relation "config.kpis_view" does not exist`
- ⚠️ Возможно, миграция `025_create_kpis_view.sql` не применена

## Анализ отображения на фронтенде

### Логика отображения (из кода):

1. **DynamicDashboard.tsx** (строка 550-560):
   - Фильтрует компоненты типа `card` из секций layout
   - Рендерит `<KPICard>` для каждого компонента
   - Передает `kpis={kpis}` в компонент

2. **KPICard.tsx** (строки 55-83):
   - Получает `kpis` из props или из кэша React Query
   - Ищет компонент в layout по `componentId`
   - Ищет KPI по `component.componentId`
   - **Если компонент или KPI не найдены - возвращает `null` (не рендерит карточку)**

### Ожидаемое отображение:

**Должны отображаться:**
- ✅ `capital_card` - есть в layout и в данных API
- ✅ `roa_card` - есть в layout и в данных API

**Не должны отображаться:**
- ❌ `ebitda_card` - есть в layout, но нет в данных API (KPICard вернет `null`)
- ❌ `roe_card` - нет в layout для `main_dashboard`

**Проблема с дублированием:**
- ⚠️ `capital_card` присутствует 2 раза в layout - может отображаться 2 карточки с одинаковыми данными

## Выводы

### Что работает ✅
1. ✅ API возвращает данные для `capital_card` и `roa_card`
2. ✅ Frontend код корректно обрабатывает данные
3. ✅ Логика отображения работает правильно

### Что не работает ⚠️
1. ⚠️ **Отображается только 2 карточки** вместо ожидаемых 3-4
   - Причина: `roe_card` отсутствует в layout для `main_dashboard`
   - Причина: `ebitda_card` отсутствует в данных API

2. ⚠️ **Дублирование `capital_card`** в layout
   - Может привести к отображению 2 одинаковых карточек

3. ⚠️ **View `config.kpis_view` не существует**
   - Возможно, миграция не применена
   - Это может влиять на работу нового endpoint

## Рекомендации

### Для Backend:
1. ⚠️ **Применить миграцию `025_create_kpis_view.sql`** (если не применена)
2. ⚠️ **Добавить `roe_card` в layout** для `main_dashboard` (если должен отображаться)
3. ⚠️ **Убрать дублирование `capital_card`** в layout
4. ⚠️ **Проверить, почему `ebitda_card` нет в данных** (или убрать из layout, если не нужен)

### Для Frontend:
1. ✅ **Код работает корректно** - карточки отображаются для тех KPI, которые есть в данных
2. ⏸️ **Ожидает исправления Backend** (добавления `roe_card` в layout)

## Проверка отображения

### Как проверить вручную:

1. **Откройте браузер:** `http://localhost:8080`
2. **Проверьте визуально:**
   - Видны ли карточки на странице?
   - Сколько карточек отображается?
   - Какие названия у карточек?

3. **Откройте DevTools (F12):**
   - **Console:** проверьте предупреждения типа `KPI card not found for componentId: ...`
   - **Network:** проверьте запросы к `/api/data?query_id=kpis`
   - **Elements:** найдите элементы с `data-component-type="card"`

### Ожидаемый результат:
- Должны отображаться **2 карточки**: `capital_card` и `roa_card`
- Если `capital_card` дублируется в layout - может быть 2 карточки с одинаковым названием

## Файлы

### Созданные файлы:
- ✅ `e2e/kpi-cards-display.spec.ts` - E2E тесты (требуют браузеры Playwright)
- ✅ `test-kpi-cards-display.sh` - bash скрипт для проверки API
- ✅ `backend/src/scripts/check-kpi-cards-display.ts` - скрипт для проверки БД и API
- ✅ `HOW_TO_TEST_KPI_CARDS.md` - руководство по тестированию
- ✅ `KPI_CARDS_DISPLAY_CHECK_REPORT.md` - этот отчет

## Заключение

✅ **API работает и возвращает данные для 2 KPI карточек**
✅ **Frontend код корректно обрабатывает данные**
⚠️ **Отображаются только 2 карточки** (`capital_card`, `roa_card`) вместо ожидаемых 3-4
⚠️ **Проблемы:**
- `roe_card` отсутствует в layout для `main_dashboard`
- `ebitda_card` отсутствует в данных API
- `capital_card` дублируется в layout

**Карточки должны отображаться на фронтенде, но не все ожидаемые.**
