# План: Шаг 3 — QA

**Цель:** проверить wrapJson в SQL builder.
**Статус:** ✅ Завершено

## Задачи
- [x] Добавить/обновить тесты для wrapJson:
  - true → запрос оборачивается ✅
  - false → запрос не оборачивается ✅
- [x] Проверить что JSON‑обертка корректна и исполнима ✅

## Файлы для изменения
- `backend/src/services/queryBuilder/__tests__/builder.test.ts`

## Критерии завершения
- [x] Тесты проходят ✅
- [x] Поведение соответствует контракту ✅

## Результаты проверки

### Тесты для wrapJson = false
1. **Обычный SQL без обертки** ✅
   - Тест: при `wrapJson=false` SQL не содержит `jsonb_agg` и `row_to_json`
   - Проверка: базовый SQL возвращается как есть

2. **buildQueryFromId с wrapJson=false из БД** ✅
   - Тест: `header_dates` (wrap_json=FALSE) → обычный SQL
   - Тест: `assets_table` (wrap_json=FALSE) → обычный SQL

### Тесты для wrapJson = true
1. **Оборачивание в jsonb_agg** ✅
   - Тест: при `wrapJson=true` SQL содержит `jsonb_agg(row_to_json(t))`
   - Тест: структура `SELECT jsonb_agg(row_to_json(t)) FROM (...) t`
   - Проверка: базовый SQL присутствует внутри обертки

2. **Сложные запросы с GROUP BY и ORDER BY** ✅
   - Тест: корректное оборачивание запросов с GROUP BY, ORDER BY, LIMIT
   - Проверка: все части запроса сохраняются внутри обертки

3. **Валидность SQL структуры** ✅
   - Тест: проверка синтаксической корректности (закрытые скобки)
   - Тест: проверка структуры SQL для исполнения
   - Тест: обработка пустых результатов

### Проверка исполняемости
- ✅ SQL с jsonb_agg имеет корректную структуру
- ✅ Внутренний SELECT корректен и исполним
- ✅ Обработка edge cases (пустые результаты, сложные запросы)
