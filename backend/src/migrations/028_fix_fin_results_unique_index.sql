-- Миграция 028: Исправление уникального индекса для ods.fin_results
-- Проблема: soft-delete не успевает сработать до INSERT, конфликт уникальности
-- Решение: Убираем уникальный индекс с условием WHERE deleted_at IS NULL,
--          оставляем обычный индекс для производительности
-- Дата: 2026-01-23

-- ============================================
-- УДАЛЕНИЕ ПРОБЛЕМНОГО УНИКАЛЬНОГО ИНДЕКСА
-- ============================================

-- Удаляем уникальный индекс который вызывает проблемы
DROP INDEX IF EXISTS ods.uq_ods_fin_results_unique;

-- ============================================
-- СОЗДАНИЕ НОВОГО ИНДЕКСА (не уникального)
-- ============================================

-- Создаём обычный индекс для быстрого поиска по бизнес-ключу
CREATE INDEX IF NOT EXISTS idx_ods_fin_results_business_key 
ON ods.fin_results(
  period_date, class, category, 
  COALESCE(item, ''), COALESCE(subitem, ''), 
  COALESCE(client_type, ''), COALESCE(currency_code, ''), COALESCE(data_source, '')
) WHERE deleted_at IS NULL;

-- ============================================
-- КОММЕНТАРИЙ
-- ============================================

COMMENT ON INDEX ods.idx_ods_fin_results_business_key IS 
'Индекс для быстрого поиска по бизнес-ключу. Не уникальный — дубликаты контролируются soft-delete логикой в коде.';
