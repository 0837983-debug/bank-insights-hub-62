// Prisma schema для Bank Insights Hub
// Автоматически сгенерировано на основе существующих миграций

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// SCHEMA: dashboard
// ============================================================

model DashboardKpiCategory {
  id        String   @id @db.VarChar(50)
  name      String   @db.VarChar(100)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  metrics DashboardKpiMetric[]

  @@map("kpi_categories")
  @@schema("dashboard")
}

model DashboardKpiMetric {
  id          String   @id @db.VarChar(50)
  title       String   @db.VarChar(200)
  value       String   @db.VarChar(50)
  subtitle    String?  @db.VarChar(200)
  description String?  @db.Text
  change      Decimal? @db.Decimal(10, 2)
  ytdChange   Decimal? @map("ytd_change") @db.Decimal(10, 2)
  categoryId  String?  @map("category_id") @db.VarChar(50)
  iconName    String?  @map("icon_name") @db.VarChar(100)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  category DashboardKpiCategory? @relation(fields: [categoryId], references: [id])

  @@index([categoryId], map: "idx_kpi_metrics_category")
  @@index([sortOrder], map: "idx_kpi_metrics_sort")
  @@map("kpi_metrics")
  @@schema("dashboard")
}

model DashboardTableData {
  id          Int      @id @default(autoincrement())
  tableId     String   @map("table_id") @db.VarChar(100)
  rowId       String   @map("row_id") @db.VarChar(100)
  name        String   @db.VarChar(500)
  description String?  @db.Text
  value       Decimal? @db.Decimal(20, 2)
  percentage  Decimal? @db.Decimal(10, 4)
  change      Decimal? @db.Decimal(10, 2)
  isGroup     Boolean  @default(false) @map("is_group")
  isTotal     Boolean  @default(false) @map("is_total")
  parentId    String?  @map("parent_id") @db.VarChar(100)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@unique([tableId, rowId])
  @@index([tableId], map: "idx_table_data_table_id")
  @@index([tableId, parentId], map: "idx_table_data_parent")
  @@map("table_data")
  @@schema("dashboard")
}

model DashboardChartData {
  id        Int      @id @default(autoincrement())
  chartId   String   @unique @map("chart_id") @db.VarChar(100)
  dataJson  Json     @map("data_json")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([chartId], map: "idx_chart_data_chart_id")
  @@map("chart_data")
  @@schema("dashboard")
}

// ============================================================
// SCHEMA: config
// ============================================================

model ConfigFormat {
  id                      String   @id @db.VarChar(100)
  name                    String   @db.VarChar(200)
  kind                    String   @db.VarChar(50)
  prefixUnitSymbol        String?  @map("prefix_unit_symbol") @db.VarChar(20)
  suffixUnitSymbol        String?  @map("suffix_unit_symbol") @db.VarChar(50)
  minimumFractionDigits   Int?     @map("minimum_fraction_digits")
  maximumFractionDigits   Int?     @map("maximum_fraction_digits")
  thousandSeparator       Boolean  @default(false) @map("thousand_separator")
  shorten                 Boolean  @default(false)
  multiplier              Decimal? @db.Decimal(10, 4)
  currency                String?  @db.VarChar(10)
  pattern                 String?  @db.VarChar(200)
  colorRules              Json?    @map("color_rules")
  symbolRules             Json?    @map("symbol_rules")
  customRules             Json?    @map("custom_rules")
  description             String?  @db.Text
  example                 String?  @db.VarChar(200)
  displayOrder            Int      @default(0) @map("display_order")
  category                String?  @db.VarChar(50)
  isActive                Boolean  @default(true) @map("is_active")
  isSystem                Boolean  @default(false) @map("is_system")
  createdBy               String?  @map("created_by") @db.VarChar(100)
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy               String?  @map("updated_by") @db.VarChar(100)
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedBy               String?  @map("deleted_by") @db.VarChar(100)
  deletedAt               DateTime? @map("deleted_at") @db.Timestamp(6)
  validationRules         Json?    @map("validation_rules")

  componentFields ConfigComponentField[]

  @@index([category], map: "idx_formats_category")
  @@index([displayOrder], map: "idx_formats_display_order")
  @@index([isActive], map: "idx_formats_is_active")
  @@index([kind], map: "idx_formats_kind")
  @@map("formats")
  @@schema("config")
}

model ConfigLayout {
  id          String   @id @db.VarChar(100)
  name        String   @db.VarChar(200)
  description String?  @db.Text
  status      String?  @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  ownerUserId String?  @map("owner_user_id") @db.VarChar(100)
  tags        String[] @db.VarChar(200)
  category    String?  @db.VarChar(100)
  displayOrder Int     @default(0) @map("display_order")
  settings    Json?
  createdBy   String?  @map("created_by") @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy   String?  @map("updated_by") @db.VarChar(100)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedBy   String?  @map("deleted_by") @db.VarChar(100)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamp(6)

  componentMappings ConfigLayoutComponentMapping[]

  @@index([isActive], map: "idx_layouts_is_active")
  @@index([isDefault], map: "idx_layouts_is_default")
  @@index([displayOrder], map: "idx_layouts_display_order")
  @@index([category], map: "idx_layouts_category")
  @@map("layouts")
  @@schema("config")
}

model ConfigComponent {
  id              String   @id @db.VarChar(200)
  componentType   String   @map("component_type") @db.VarChar(50)
  title           String?  @db.VarChar(200)
  label           String?  @db.VarChar(200)
  tooltip         String?  @db.VarChar(500)
  icon            String?  @db.VarChar(200)
  dataSourceKey   String?  @map("data_source_key") @db.VarChar(200)
  actionType      String?  @map("action_type") @db.VarChar(100)
  actionTarget    String?  @map("action_target") @db.VarChar(200)
  actionParams    Json?    @map("action_params")
  settings        Json?
  description     String?  @db.Text
  category        String?  @db.VarChar(100)
  isActive        Boolean  @default(true) @map("is_active")
  createdBy       String?  @map("created_by") @db.VarChar(100)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy       String?  @map("updated_by") @db.VarChar(100)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedBy       String?  @map("deleted_by") @db.VarChar(100)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamp(6)

  componentMappings ConfigLayoutComponentMapping[]
  componentFields   ConfigComponentField[]

  @@index([componentType], map: "idx_components_type")
  @@index([isActive], map: "idx_components_is_active")
  @@index([category], map: "idx_components_category")
  @@map("components")
  @@schema("config")
}

model ConfigLayoutComponentMapping {
  id                    Int      @id @default(autoincrement())
  layoutId              String   @map("layout_id") @db.VarChar(100)
  componentId           String   @map("component_id") @db.VarChar(200)
  instanceId            String   @map("instance_id") @db.VarChar(200)
  parentInstanceId      String?  @map("parent_instance_id") @db.VarChar(200)
  displayOrder          Int      @default(0) @map("display_order")
  isVisible             Boolean  @default(true) @map("is_visible")
  titleOverride         String?  @map("title_override") @db.VarChar(200)
  labelOverride         String?  @map("label_override") @db.VarChar(200)
  tooltipOverride       String?  @map("tooltip_override") @db.VarChar(500)
  iconOverride          String?  @map("icon_override") @db.VarChar(200)
  dataSourceKeyOverride String?  @map("data_source_key_override") @db.VarChar(200)
  actionParamsOverride  Json?    @map("action_params_override")
  settingsOverride      Json?    @map("settings_override")
  createdBy             String?  @map("created_by") @db.VarChar(100)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy             String?  @map("updated_by") @db.VarChar(100)
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedBy             String?  @map("deleted_by") @db.VarChar(100)
  deletedAt             DateTime? @map("deleted_at") @db.Timestamp(6)

  layout    ConfigLayout    @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  component ConfigComponent @relation(fields: [componentId], references: [id], onDelete: Restrict)

  @@unique([layoutId, instanceId], map: "uq_lcm_layout_instance")
  @@index([layoutId], map: "idx_lcm_layout")
  @@index([parentInstanceId], map: "idx_lcm_parent")
  @@index([componentId], map: "idx_lcm_component")
  @@index([displayOrder], map: "idx_lcm_display_order")
  @@index([isVisible], map: "idx_lcm_is_visible")
  @@map("layout_component_mapping")
  @@schema("config")
}

model ConfigComponentField {
  id            Int      @id @default(autoincrement())
  componentId   String   @map("component_id") @db.VarChar(200)
  fieldId       String   @map("field_id") @db.VarChar(200)
  fieldType     String   @map("field_type") @db.VarChar(50)
  label         String?  @db.VarChar(200)
  description   String?  @db.Text
  dataKey       String?  @map("data_key") @db.VarChar(200)
  formatId      String?  @map("format_id") @db.VarChar(100)
  parentFieldId String?  @map("parent_field_id") @db.VarChar(200)
  isVisible     Boolean  @default(true) @map("is_visible")
  isSortable    Boolean  @default(false) @map("is_sortable")
  width         Int?
  align         String?  @db.VarChar(20)
  settings      Json?
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdBy     String?  @map("created_by") @db.VarChar(100)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedBy     String?  @map("updated_by") @db.VarChar(100)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedBy     String?  @map("deleted_by") @db.VarChar(100)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamp(6)

  component ConfigComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  format    ConfigFormat?    @relation(fields: [formatId], references: [id], onDelete: SetNull)

  @@unique([componentId, fieldId], map: "uq_cf_component_field_active")
  @@index([componentId], map: "idx_cf_component")
  @@index([fieldId], map: "idx_cf_field_id")
  @@index([displayOrder], map: "idx_cf_display_order")
  @@index([isActive], map: "idx_cf_is_active")
  @@index([parentFieldId], map: "idx_cf_parent_field")
  @@map("component_fields")
  @@schema("config")
}

model ConfigMartField {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  fieldName     String   @unique @map("field_name") @db.VarChar(100)
  fieldType     String   @map("field_type") @db.VarChar(50)
  hierarchyLevel Int?    @map("hierarchy_level")
  category      String?  @db.VarChar(100)
  description   String?  @db.Text
  dataType      String   @default("VARCHAR") @map("data_type") @db.VarChar(50)
  maxLength     Int?     @map("max_length")
  isRequired    Boolean  @default(false) @map("is_required")
  isNullable    Boolean  @default(true) @map("is_nullable")
  metadata      Json?
  isActive      Boolean  @default(true) @map("is_active")

  @@index([fieldType], map: "idx_mart_fields_type")
  @@index([category], map: "idx_mart_fields_category")
  @@index([hierarchyLevel], map: "idx_mart_fields_hierarchy_level")
  @@index([isActive], map: "idx_mart_fields_active")
  @@map("mart_fields")
  @@schema("config")
}

// ============================================================
// SCHEMA: mart
// ============================================================

model MartKpiMetric {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  componentId String   @map("component_id") @db.VarChar(200)
  periodDate  DateTime @map("period_date") @db.Date
  value       Decimal  @map("value") @db.Decimal(20, 2)

  @@unique([componentId, periodDate])
  @@index([componentId], map: "idx_kpi_metrics_component")
  @@index([periodDate(sort: Desc)], map: "idx_kpi_metrics_date")
  @@index([componentId, periodDate(sort: Desc)], map: "idx_kpi_metrics_component_date")
  @@map("kpi_metrics")
  @@schema("mart")
}

model MartFinancialResult {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  tableComponentId String  @map("table_component_id") @db.VarChar(200)
  rowCode         String   @map("row_code") @db.VarChar(100)
  periodDate      DateTime @map("period_date") @db.Date
  value           Decimal  @map("value") @db.Decimal(20, 2)
  reportClass     String   @map("report_class") @db.VarChar(50)
  plSection       String?  @map("pl_section") @db.VarChar(100)
  lineItem        String?  @map("line_item") @db.VarChar(200)
  subLineItem     String?  @map("sub_line_item") @db.VarChar(200)
  cfoCode         String?  @map("cfo_code") @db.VarChar(100)
  productCode     String?  @map("product_code") @db.VarChar(100)
  productGroup    String?  @map("product_group") @db.VarChar(100)
  clientSegment   String?  @map("client_segment") @db.VarChar(100)
  channel         String?  @db.VarChar(100)
  region          String?  @db.VarChar(100)
  projectCode     String?  @map("project_code") @db.VarChar(100)
  currencyCode    String   @default("RUB") @map("currency_code") @db.VarChar(10)
  dimensions      Json?

  @@unique([tableComponentId, rowCode, periodDate, reportClass, plSection, lineItem, subLineItem, cfoCode, productCode, clientSegment, channel, region, projectCode, currencyCode])
  @@index([tableComponentId], map: "idx_fr_component")
  @@index([periodDate(sort: Desc)], map: "idx_fr_date")
  @@index([rowCode, periodDate], map: "idx_fr_row_code")
  @@index([reportClass, periodDate], map: "idx_fr_report_class")
  @@index([plSection, periodDate], map: "idx_fr_pl_section")
  @@index([lineItem, periodDate], map: "idx_fr_line_item")
  @@index([cfoCode, periodDate], map: "idx_fr_cfo")
  @@index([productCode, periodDate], map: "idx_fr_product")
  @@index([clientSegment, periodDate], map: "idx_fr_segment")
  @@index([channel, periodDate], map: "idx_fr_channel")
  @@index([region, periodDate], map: "idx_fr_region")
  @@index([currencyCode, periodDate], map: "idx_fr_currency")
  @@index([tableComponentId, periodDate(sort: Desc), reportClass], map: "idx_fr_component_date_class")
  @@map("financial_results")
  @@schema("mart")
}

model MartBalance {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  tableComponentId String  @map("table_component_id") @db.VarChar(200)
  rowCode         String   @map("row_code") @db.VarChar(100)
  periodDate      DateTime @map("period_date") @db.Date
  value           Decimal  @map("value") @db.Decimal(20, 2)
  balanceClass    String   @map("balance_class") @db.VarChar(50)
  balanceSection  String?  @map("balance_section") @db.VarChar(100)
  balanceItem     String?  @map("balance_item") @db.VarChar(200)
  subBalanceItem  String?  @map("sub_balance_item") @db.VarChar(200)
  clientType      String?  @map("client_type") @db.VarChar(50)
  clientSegment   String?  @map("client_segment") @db.VarChar(100)
  productCode     String?  @map("product_code") @db.VarChar(100)
  portfolioCode   String?  @map("portfolio_code") @db.VarChar(100)
  currencyCode    String   @default("RUB") @map("currency_code") @db.VarChar(10)
  maturityBucket  String?  @map("maturity_bucket") @db.VarChar(50)
  interestType    String?  @map("interest_type") @db.VarChar(50)
  collateralType  String?  @map("collateral_type") @db.VarChar(100)
  riskClass       String?  @map("risk_class") @db.VarChar(50)
  orgUnitCode     String?  @map("org_unit_code") @db.VarChar(100)
  region          String?  @db.VarChar(100)
  dimensions      Json?

  @@unique([tableComponentId, rowCode, periodDate, balanceClass, balanceSection, balanceItem, subBalanceItem, clientType, clientSegment, productCode, portfolioCode, currencyCode, maturityBucket, interestType, collateralType, riskClass, orgUnitCode, region])
  @@index([tableComponentId], map: "idx_balance_component")
  @@index([periodDate(sort: Desc)], map: "idx_balance_date")
  @@index([rowCode, periodDate], map: "idx_balance_row_code")
  @@index([balanceClass, periodDate], map: "idx_balance_class")
  @@index([balanceSection, periodDate], map: "idx_balance_section")
  @@index([balanceItem, periodDate], map: "idx_balance_item")
  @@index([clientType, periodDate], map: "idx_balance_client_type")
  @@index([clientSegment, periodDate], map: "idx_balance_segment")
  @@index([productCode, periodDate], map: "idx_balance_product")
  @@index([currencyCode, periodDate], map: "idx_balance_currency")
  @@index([maturityBucket, periodDate], map: "idx_balance_maturity")
  @@index([interestType, periodDate], map: "idx_balance_interest_type")
  @@index([riskClass, periodDate], map: "idx_balance_risk_class")
  @@index([region, periodDate], map: "idx_balance_region")
  @@index([tableComponentId, periodDate(sort: Desc), balanceClass], map: "idx_balance_component_date_class")
  @@map("balance")
  @@schema("mart")
}
